# Глава 5: Анализ сети

## Обзор

`NetworkCollector` собирает данные из трёх источников: счётчики интерфейсов, статистика TCP-протокола и состояния сокетов.

## Функции

| Функция | Источник | Что собирает |
|---------|---------|-------------|
| `parseNetDev()` | `/proc/net/dev` | rx/tx bytes, packets, errors, drops по интерфейсам |
| `parseSNMP()` | `/proc/net/snmp` | CurrEstab, ActiveOpens, RetransSegs, InErrs |
| `parseSSConnections()` | `ss -s`, `ss -tn state close-wait` | TIME_WAIT и CLOSE_WAIT |

## Глубокий анализ (Tier 2/3)

Счётчики ошибок в `/proc/net/snmp` накапливаются с загрузки. Сложно понять, происходят ли ошибки *сейчас*.

### tcpconnlat (Tier 2)
Измеряет время установления соединения (Handshake: SYN -> SYN/ACK -> ACK).
- **Полезно**: Если приложение жалуется на таймауты подключения.
- **Причина**: Перегрузка сети, медленный DNS, удалённый сервер.

### tcpretrans (Tier 2/3)
Показывает каждую ретрансмиссию пакета в реальном времени (Source IP, Dest IP, Port).
- **Нативный eBPF (Tier 3)**: Работает без Python, очень быстро.
- **Полезно**: Понять, *какое именно* соединение теряет пакеты.

### gethostlatency (Tier 2)
Задержки DNS-запросов (getaddrinfo/gethostbyname).
- Часто "тормоза сети" оказываются тормозами DNS.

## Проблемы TCP состояний

| Состояние | Число | Значение |
|-----------|-------|---------|
| TIME_WAIT < 1000 | Норма | Соединения остывают |
| TIME_WAIT > 50000 | Риск | Могут закончиться эфемерные порты |
| CLOSE_WAIT > 0 | Баг! | Приложение не закрывает сокет |
| CLOSE_WAIT > 100 | Критический баг | Утечка соединений |

## Sysctl параметры

| Параметр | Типичное | Назначение |
|----------|---------|-----------|
| `tcp_congestion_control` | `cubic` | Алгоритм перегрузки (bbr лучше для WAN) |
| `tcp_rmem` | `4096 131072 6291456` | Буфер приёма TCP (мин/дефолт/макс) |
| `somaxconn` | 4096 | Макс. очередь listen |

---

*Далее: [Глава 6 — Анализ процессов](06-process-analysis.md)*
