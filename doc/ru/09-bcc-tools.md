# Глава 9: Инструменты BCC — Глубокая трассировка ядра

## Обзор

Коллекторы Tier 1 читают счётчики из `/proc` — они говорят **что** происходит. BCC-инструменты говорят **почему**: латентность, стеки, per-event данные.

## Файлы: executor/ (5 файлов)

| Файл | Назначение |
|------|-----------|
| `executor.go` | `BCCExecutor` — запуск инструментов с защитой |
| `security.go` | `SecurityChecker` — верификация бинарников |
| `registry.go` | Каталог 20 BCC-инструментов |
| `parsers.go` | Парсеры (гистограммы, таблицы, стеки) |
| `aggregate.go` | Агрегация (Top-N, соединения) |

## Модель безопасности

- Бинарники ищутся только в разрешённых путях (`/usr/share/bcc/tools`, `/usr/sbin`, `/usr/bin`)
- Проверяется владелец (root) и права (не world-writable)
- Окружение санитизируется (убираются LD_PRELOAD и т.д.)
- Вывод ограничен 50МБ

## Каталог инструментов

### CPU
| Инструмент | Что трассирует | Тип вывода |
|-----------|---------------|------------|
| **runqlat** | Время в очереди CPU | Гистограмма (μs) |
| **profile** | Сэмплирование стека CPU | Folded стеки |
| **offcputime** | Почему процесс заблокирован | Folded стеки |

### Диск
| Инструмент | Что трассирует | Тип вывода |
|-----------|---------------|------------|
| **biolatency** | Латентность блочного I/O | Гистограмма (μs) |
| **biosnoop** | Каждая операция I/O | Таблица (per-event) |

### Сеть
| Инструмент | Что трассирует | Тип вывода |
|-----------|---------------|------------|
| **tcpconnlat** | Время установления TCP-соединения | Таблица |
| **tcpretrans** | Ретрансмиссии TCP | Таблица |
| **tcpdrop** | Сброшенные TCP-пакеты | Таблица |

## Гистограммы: как читать

Гистограмма показывает распределение значений по степеням двойки:

```
     usecs               : count    distribution
         4 -> 7          : 15       |****                                    |
         8 -> 15         : 107      |*****************************           |
        16 -> 31         : 145      |****************************************|
        32 -> 63         : 83       |***********************                 |
        64 -> 127        : 12       |***                                     |
```

Из этого вычисляются перцентили (P50, P90, P99, P999):
- **P99 < 100μs** для runqlat = хороший CPU
- **P99 > 1ms** для biolatency на SSD = проблема

---

*Далее: [Глава 10 — Нативный eBPF](10-ebpf-native.md)*
